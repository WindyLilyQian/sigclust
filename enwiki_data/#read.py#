from sys import argv

def read_data(f, features, rids=False):
    """
    Expects f to have tsv format.
    Reads a set of features and a label from a file one row at a time.
    rids says to expect the first column to be id numbers.
    """
    for line in f: # Implicitly splits rows on \n
        parts = line.strip().split("\t") # Splits columns on \t

        if rids:
            rev_id = parts[0]
            parts = parts[1:]
            
        values = parts[:-1] # All but the last column are feature values.
        label = parts[-1] # Last column is a label

        feature_values = []
        for feature, value in zip(features, values): 
            # Each feature knows its type and will perform the right conversion
            
            if feature.returns == bool:
                # Booleans are weird.  bool("False") == True, so you need to string match "True"
                feature_values.append(value == "True")
            else:
                feature_values.append(feature.returns(value))

        row = feature_values[:]
        row.append(label == "True")
        if rids:
            row.insert(0, int(rev_id))
                
        yield row



from editquality.feature_lists import enwiki
import numpy as np
from sigclust.sigclust import sigclust

def get_mat(file_name, rids = True):
    """
    Reads data in file_name into a np. array.
    When rids == False, assumes all columns of the file from file_name are feature data except for the last colume which is assumed to be labels.
    When rids==True  assumes in addition that the first column is rev_ids and returns a *tuple* of that colum of ids together with the usual output np.array
    """

    f = open(file_name)

    rows = list(read_data(f, enwiki.damaging, rids))

    mat = np.array(rows).astype(float)

    #Last column is the label
    labels = mat[:, -1]
    result = mat[:, :-1]

    #if rids then expect first colun to be rev_ids
    if rids:
        rid_col = result[:, 0]
        return rid_col, result[:, 1:], labels
    else:
        return result, labels

